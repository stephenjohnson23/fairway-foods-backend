<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2e7d32">
    <title>Fairway Foods</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
        }
        
        .app-container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        
        /* Customer app container */
        .customer-container {
            max-width: 480px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 700;
        }
        
        .header-subtitle {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* Screens */
        .screen { display: none; padding: 20px; }
        .screen.active { display: block; }
        
        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #2e7d32;
        }
        
        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-primary { background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%); color: white; }
        .btn-secondary { background: #f5f5f5; color: #333; margin-top: 10px; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-sm { padding: 8px 14px; font-size: 13px; width: auto; }
        
        .link-btn {
            background: none;
            border: none;
            color: #2e7d32;
            font-size: 14px;
            cursor: pointer;
            margin-top: 20px;
            text-decoration: underline;
        }
        
        /* Login */
        .login-container { padding-top: 40px; max-width: 400px; margin: 0 auto; }
        
        /* Course cards */
        .course-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .course-card:hover { border-color: #2e7d32; }
        .course-card h3 { font-size: 16px; margin-bottom: 4px; }
        .course-card p { color: #666; font-size: 13px; }
        
        /* Menu */
        .menu-categories {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 12px 0;
            margin-bottom: 12px;
        }
        .category-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: #f0f0f0;
            font-size: 13px;
            white-space: nowrap;
            cursor: pointer;
        }
        .category-btn.active { background: #2e7d32; color: white; }
        
        .menu-item {
            background: white;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .menu-item-info h4 { font-size: 15px; margin-bottom: 2px; }
        .menu-item-info p { color: #666; font-size: 12px; margin-bottom: 4px; }
        .menu-item-price { color: #2e7d32; font-weight: 600; }
        
        .add-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #2e7d32;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* Cart badge */
        .cart-badge {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: #2e7d32;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.4);
            z-index: 100;
            display: none;
            font-size: 14px;
        }
        .cart-badge.visible { display: flex; align-items: center; gap: 8px; }
        
        /* Cart */
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .cart-item-qty { display: flex; align-items: center; gap: 10px; }
        .qty-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #2e7d32;
            background: white;
            color: #2e7d32;
            font-size: 16px;
            cursor: pointer;
        }
        .cart-total {
            padding: 16px;
            background: #f9f9f9;
            border-radius: 12px;
            margin: 16px 0;
        }
        .cart-total-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .cart-total-row.total {
            font-size: 18px;
            font-weight: 700;
            color: #2e7d32;
            border-top: 2px solid #e0e0e0;
            padding-top: 8px;
            margin-top: 8px;
        }
        
        /* Orders */
        .order-card {
            background: white;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .order-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .order-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-pending, .badge-pending { background: #fff3cd; color: #856404; }
        .status-preparing, .badge-preparing { background: #cce5ff; color: #004085; }
        .status-ready, .badge-ready { background: #d4edda; color: #155724; }
        .status-completed, .badge-completed { background: #e2e3e5; color: #383d41; }
        
        /* Bottom nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            background: none;
            border: none;
            color: #999;
            font-size: 11px;
            cursor: pointer;
            padding: 6px 12px;
        }
        .nav-item.active { color: #2e7d32; }
        .nav-item .icon { font-size: 20px; }
        
        /* Staff specific */
        .staff-container { max-width: 1200px; margin: 0 auto; }
        
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 6px 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        .tab-btn.active { border-color: #2e7d32; background: #2e7d32; color: white; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .stat-card {
            background: white;
            padding: 10px 8px;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            text-align: center;
        }
        .stat-card h3 { font-size: 10px; color: #666; margin-bottom: 2px; }
        .stat-card .value { font-size: 22px; font-weight: 700; color: #2e7d32; }
        
        .staff-order-card {
            background: white;
            border-radius: 8px;
            padding: 8px 10px;
            margin-bottom: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            border-left: 4px solid #2e7d32;
        }
        .staff-order-card.status-pending { border-left-color: #ffc107; }
        .staff-order-card.status-preparing { border-left-color: #17a2b8; }
        .staff-order-card.status-ready { border-left-color: #28a745; }
        .staff-order-card.status-completed { border-left-color: #6c757d; }
        
        .badge {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 200;
        }
        .toast.visible { opacity: 1; }
        
        /* Empty state */
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        
        /* Pending approval */
        .pending-approval { text-align: center; padding: 60px 20px; }
        .pending-approval h2 { margin-bottom: 10px; }
        .pending-approval p { color: #666; }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }
        .modal-overlay.visible { display: flex; }
        .modal {
            background: white;
            border-radius: 16px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal h2 { margin-bottom: 16px; font-size: 18px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 16px; }
        .modal-actions .btn { flex: 1; }
        
        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div>
                <h1>‚õ≥ Fairway Foods</h1>
                <p class="header-subtitle" id="headerSubtitle">Order food on the course</p>
            </div>
            <div class="header-right" id="headerRight" style="display: none;">
                <span class="user-badge" id="userBadge"></span>
                <button class="logout-btn" onclick="logout()">Sign Out</button>
            </div>
        </div>
        
        <!-- Login Screen -->
        <div class="screen active" id="loginScreen">
            <div class="customer-container">
                <div class="login-container">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <button class="btn btn-primary" onclick="login()">Sign In</button>
                    <button class="btn btn-secondary" onclick="showScreen('registerScreen')">Create Account</button>
                    <button class="link-btn" onclick="showScreen('forgotPasswordScreen')">Forgot Password?</button>
                </div>
            </div>
        </div>
        
        <!-- Register Screen -->
        <div class="screen" id="registerScreen">
            <div class="customer-container">
                <div class="login-container">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="registerName" placeholder="John Smith">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="registerEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="registerPassword" placeholder="Create a password">
                    </div>
                    <button class="btn btn-primary" onclick="register()">Create Account</button>
                    <button class="btn btn-secondary" onclick="showScreen('loginScreen')">Back to Sign In</button>
                </div>
            </div>
        </div>
        
        <!-- Forgot Password Screen -->
        <div class="screen" id="forgotPasswordScreen">
            <div class="customer-container">
                <div class="login-container">
                    <h2 style="margin-bottom: 10px;">Reset Password</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Enter your email and we'll send you a reset code.</p>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="forgotEmail" placeholder="your@email.com">
                    </div>
                    <button class="btn btn-primary" onclick="sendResetCode()">Send Reset Code</button>
                    <button class="btn btn-secondary" onclick="showScreen('loginScreen')">Back to Sign In</button>
                </div>
            </div>
        </div>
        
        <!-- Pending Approval Screen -->
        <div class="screen" id="pendingScreen">
            <div class="customer-container">
                <div class="pending-approval">
                    <div style="font-size: 60px; margin-bottom: 20px;">‚è≥</div>
                    <h2>Account Pending Approval</h2>
                    <p>Your account is being reviewed by the club administrator.</p>
                    <button class="btn btn-secondary" style="margin-top: 30px; width: auto; padding: 12px 30px;" onclick="logout()">Sign Out</button>
                </div>
            </div>
        </div>
        
        <!-- Customer: Course Selection -->
        <div class="screen" id="courseScreen">
            <div class="customer-container">
                <h2 style="margin-bottom: 16px;">Select Your Course</h2>
                <div id="courseList"></div>
            </div>
        </div>
        
        <!-- Customer: Menu -->
        <div class="screen" id="menuScreen">
            <div class="customer-container">
                <div class="menu-categories" id="categoryTabs"></div>
                <div id="menuList"></div>
            </div>
        </div>
        
        <!-- Customer: Cart -->
        <div class="screen" id="cartScreen">
            <div class="customer-container" style="padding-bottom: 100px;">
                <h2 style="margin-bottom: 16px;">Your Order</h2>
                <div id="cartItems"></div>
                <div class="cart-total" id="cartTotal" style="display: none;">
                    <div class="cart-total-row">
                        <span>Subtotal</span>
                        <span id="subtotal">R0.00</span>
                    </div>
                    <div class="cart-total-row total">
                        <span>Total</span>
                        <span id="totalAmount">R0.00</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Your Name (for pickup)</label>
                    <input type="text" id="customerName" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label>Tee-off Time (optional)</label>
                    <input type="time" id="teeOffTime">
                </div>
                <button class="btn btn-primary" id="placeOrderBtn" onclick="placeOrder()">Place Order</button>
            </div>
        </div>
        
        <!-- Customer: Orders -->
        <div class="screen" id="ordersScreen">
            <div class="customer-container">
                <h2 style="margin-bottom: 16px;">Your Orders</h2>
                <div id="ordersList"></div>
            </div>
        </div>
        
        <!-- Customer: Profile -->
        <div class="screen" id="profileScreen">
            <div class="customer-container">
                <h2 style="margin-bottom: 16px;">Profile</h2>
                <div id="userInfo" style="background: #f9f9f9; padding: 16px; border-radius: 12px; margin-bottom: 16px;"></div>
                <button class="btn btn-secondary" onclick="showPasswordModal()">Change Password</button>
                <button class="btn btn-danger" style="margin-top: 10px;" onclick="logout()">Sign Out</button>
            </div>
        </div>
        
        <!-- Staff: Dashboard -->
        <div class="screen" id="staffDashboard">
            <div class="staff-container" style="padding: 16px;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>üïê Pending</h3>
                        <div class="value" id="statPending">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>üë®‚Äçüç≥ Preparing</h3>
                        <div class="value" id="statPreparing">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>‚úÖ Ready</h3>
                        <div class="value" id="statReady">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>üì¶ Done</h3>
                        <div class="value" id="statCompleted">0</div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3>Orders</h3>
                    <button class="btn btn-sm btn-secondary" onclick="loadStaffOrders()">üîÑ Refresh</button>
                </div>
                
                <div class="tabs" id="staffOrderTabs"></div>
                <div id="staffOrdersList"></div>
            </div>
        </div>
        
        <!-- Cart Badge (Customer) -->
        <div class="cart-badge" id="cartBadge" onclick="navigateTo('cart')">
            üõí <span id="cartCount">0</span> - <span id="cartBadgeTotal">R0</span>
        </div>
        
        <!-- Bottom Navigation (Customer) -->
        <div class="bottom-nav" id="customerNav" style="display: none;">
            <button class="nav-item active" onclick="navigateTo('menu')" data-nav="menu">
                <span class="icon">üçΩÔ∏è</span>
                Menu
            </button>
            <button class="nav-item" onclick="navigateTo('cart')" data-nav="cart">
                <span class="icon">üõí</span>
                Cart
            </button>
            <button class="nav-item" onclick="navigateTo('orders')" data-nav="orders">
                <span class="icon">üìã</span>
                Orders
            </button>
            <button class="nav-item" onclick="navigateTo('profile')" data-nav="profile">
                <span class="icon">üë§</span>
                Profile
            </button>
        </div>
        
        <!-- Bottom Navigation (Staff) -->
        <div class="bottom-nav" id="staffNav" style="display: none;">
            <button class="nav-item active" onclick="staffNavigateTo('dashboard')" data-nav="dashboard">
                <span class="icon">üìä</span>
                Orders
            </button>
            <button class="nav-item" onclick="staffNavigateTo('profile')" data-nav="profile">
                <span class="icon">üë§</span>
                Profile
            </button>
        </div>
        
        <!-- Toast -->
        <div class="toast" id="toast"></div>
        
        <!-- Password Modal -->
        <div class="modal-overlay" id="passwordModal">
            <div class="modal">
                <h2>Change Password</h2>
                <div class="form-group">
                    <label>Current Password</label>
                    <input type="password" id="currentPassword" placeholder="Current password">
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="newPasswordInput" placeholder="New password">
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="hideModal('passwordModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="changePassword()">Update</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'https://fairway-foods-backend.onrender.com/api';
        
        let currentUser = null;
        let currentCourse = null;
        let menuItems = [];
        let cart = [];
        let categories = [];
        let activeCategory = 'All';
        let allOrders = [];
        let staffFilter = 'pending';
        
        // Init
        document.addEventListener('DOMContentLoaded', checkAuth);
        
        function checkAuth() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            if (token && user) {
                currentUser = JSON.parse(user);
                initializeApp();
            }
        }
        
        function initializeApp() {
            document.getElementById('headerRight').style.display = 'flex';
            document.getElementById('userBadge').textContent = currentUser.role;
            
            if (currentUser.status === 'pending') {
                showScreen('pendingScreen');
            } else if (currentUser.role === 'user') {
                // Customer flow
                document.getElementById('customerNav').style.display = 'flex';
                document.getElementById('staffNav').style.display = 'none';
                loadCourses();
            } else {
                // Staff flow
                document.getElementById('customerNav').style.display = 'none';
                document.getElementById('staffNav').style.display = 'flex';
                document.getElementById('headerSubtitle').textContent = 'Staff Portal';
                loadStaffOrders();
                showScreen('staffDashboard');
                setInterval(loadStaffOrders, 30000);
            }
        }
        
        // Auth
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showToast('Please enter email and password');
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    currentUser = data.user;
                    initializeApp();
                } else {
                    showToast(typeof data.detail === 'string' ? data.detail : 'Login failed');
                }
            } catch (e) {
                showToast('Connection error');
            }
        }
        
        async function register() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            if (!name || !email || !password) {
                showToast('Please fill all fields');
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                
                if (res.ok) {
                    showToast('Account created! Waiting for approval.');
                    showScreen('loginScreen');
                } else {
                    const data = await res.json();
                    showToast(data.detail || 'Registration failed');
                }
            } catch (e) {
                showToast('Connection error');
            }
        }
        
        async function sendResetCode() {
            const email = document.getElementById('forgotEmail').value;
            if (!email) { showToast('Please enter your email'); return; }
            
            try {
                const res = await fetch(`${API_URL}/auth/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                if (res.ok) {
                    showToast('Reset code sent to your email');
                } else {
                    showToast('Failed to send reset code');
                }
            } catch (e) {
                showToast('Connection error');
            }
        }
        
        function logout() {
            localStorage.clear();
            currentUser = null;
            currentCourse = null;
            cart = [];
            document.getElementById('headerRight').style.display = 'none';
            document.getElementById('customerNav').style.display = 'none';
            document.getElementById('staffNav').style.display = 'none';
            document.getElementById('cartBadge').classList.remove('visible');
            document.getElementById('headerSubtitle').textContent = 'Order food on the course';
            showScreen('loginScreen');
        }
        
        // Customer: Courses
        async function loadCourses() {
            try {
                const res = await fetch(`${API_URL}/courses`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                let courses = await res.json();
                
                if (currentUser.courseIds && currentUser.courseIds.length > 0) {
                    courses = courses.filter(c => currentUser.courseIds.includes(c.id));
                }
                
                if (courses.length === 1) {
                    selectCourse(courses[0].id, courses[0].name);
                    return;
                }
                
                if (courses.length === 0) {
                    document.getElementById('courseList').innerHTML = '<div class="empty-state"><p>No courses assigned to your account.</p></div>';
                    showScreen('courseScreen');
                    return;
                }
                
                document.getElementById('courseList').innerHTML = courses.map(c => `
                    <div class="course-card" onclick="selectCourse('${c.id}', '${c.name}')">
                        <h3>${c.name}</h3>
                        <p>üìç ${c.location}</p>
                    </div>
                `).join('');
                
                showScreen('courseScreen');
            } catch (e) {
                showToast('Failed to load courses');
            }
        }
        
        function selectCourse(id, name) {
            currentCourse = { id, name };
            document.getElementById('headerSubtitle').textContent = name;
            loadMenu();
        }
        
        // Customer: Menu
        async function loadMenu() {
            try {
                const res = await fetch(`${API_URL}/menu?courseId=${currentCourse.id}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                menuItems = await res.json();
                categories = ['All', ...new Set(menuItems.map(i => i.category))];
                
                renderCategories();
                renderMenu();
                showScreen('menuScreen');
            } catch (e) {
                showToast('Failed to load menu');
            }
        }
        
        function renderCategories() {
            document.getElementById('categoryTabs').innerHTML = categories.map(c => `
                <button class="category-btn ${c === activeCategory ? 'active' : ''}" onclick="filterCategory('${c}')">${c}</button>
            `).join('');
        }
        
        function filterCategory(cat) {
            activeCategory = cat;
            renderCategories();
            renderMenu();
        }
        
        function renderMenu() {
            const items = activeCategory === 'All' 
                ? menuItems.filter(i => i.available)
                : menuItems.filter(i => i.category === activeCategory && i.available);
            
            document.getElementById('menuList').innerHTML = items.length ? items.map(i => `
                <div class="menu-item">
                    <div class="menu-item-info">
                        <h4>${i.name}</h4>
                        <p>${i.description || ''}</p>
                        <span class="menu-item-price">R${i.price.toFixed(2)}</span>
                    </div>
                    <button class="add-btn" onclick="addToCart('${i.id}')">+</button>
                </div>
            `).join('') : '<div class="empty-state"><p>No items available</p></div>';
        }
        
        // Customer: Cart
        function addToCart(id) {
            const item = menuItems.find(i => i.id === id);
            if (!item) return;
            
            const existing = cart.find(c => c.id === id);
            if (existing) existing.quantity++;
            else cart.push({ ...item, quantity: 1 });
            
            updateCartBadge();
            showToast(`${item.name} added`);
        }
        
        function updateCartBadge() {
            const count = cart.reduce((s, i) => s + i.quantity, 0);
            const total = cart.reduce((s, i) => s + i.price * i.quantity, 0);
            
            document.getElementById('cartCount').textContent = count;
            document.getElementById('cartBadgeTotal').textContent = `R${total.toFixed(0)}`;
            document.getElementById('cartBadge').classList.toggle('visible', count > 0);
        }
        
        function renderCart() {
            const cartItems = document.getElementById('cartItems');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="empty-state"><p>Your cart is empty</p></div>';
                document.getElementById('cartTotal').style.display = 'none';
                document.getElementById('placeOrderBtn').style.display = 'none';
                return;
            }
            
            cartItems.innerHTML = cart.map(i => `
                <div class="cart-item">
                    <div>
                        <h4>${i.name}</h4>
                        <p style="color: #666; font-size: 13px;">R${i.price.toFixed(2)} each</p>
                    </div>
                    <div class="cart-item-qty">
                        <button class="qty-btn" onclick="updateQty('${i.id}', -1)">-</button>
                        <span>${i.quantity}</span>
                        <button class="qty-btn" onclick="updateQty('${i.id}', 1)">+</button>
                    </div>
                </div>
            `).join('');
            
            const total = cart.reduce((s, i) => s + i.price * i.quantity, 0);
            document.getElementById('subtotal').textContent = `R${total.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `R${total.toFixed(2)}`;
            document.getElementById('cartTotal').style.display = 'block';
            document.getElementById('placeOrderBtn').style.display = 'block';
        }
        
        function updateQty(id, change) {
            const item = cart.find(c => c.id === id);
            if (!item) return;
            
            item.quantity += change;
            if (item.quantity <= 0) cart = cart.filter(c => c.id !== id);
            
            updateCartBadge();
            renderCart();
        }
        
        async function placeOrder() {
            if (cart.length === 0) { showToast('Cart is empty'); return; }
            
            const customerName = document.getElementById('customerName').value || currentUser.name;
            const teeOffTime = document.getElementById('teeOffTime').value;
            
            try {
                const res = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        items: cart.map(i => ({ menuItemId: i.id, name: i.name, price: i.price, quantity: i.quantity })),
                        total: cart.reduce((s, i) => s + i.price * i.quantity, 0),
                        customerName,
                        teeOffTime: teeOffTime || "",
                        courseId: currentCourse.id
                    })
                });
                
                if (res.ok) {
                    cart = [];
                    updateCartBadge();
                    showToast('Order placed!');
                    navigateTo('orders');
                } else {
                    showToast('Failed to place order');
                }
            } catch (e) {
                showToast('Connection error');
            }
        }
        
        // Customer: Orders
        async function loadCustomerOrders() {
            try {
                const res = await fetch(`${API_URL}/orders`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                let orders = await res.json();
                if (currentUser.id) orders = orders.filter(o => o.userId === currentUser.id);
                
                const list = document.getElementById('ordersList');
                
                if (orders.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>No orders yet</p></div>';
                    return;
                }
                
                list.innerHTML = orders.map(o => `
                    <div class="order-card">
                        <div class="order-header">
                            <span style="color: #666; font-size: 13px;">${new Date(o.createdAt).toLocaleDateString()}</span>
                            <span class="order-status status-${o.status}">${o.status}</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            ${o.items.map(i => `<p style="font-size: 13px;">${i.quantity}x ${i.name}</p>`).join('')}
                        </div>
                        <div style="display: flex; justify-content: space-between; font-weight: 600;">
                            <span>Total</span>
                            <span style="color: #2e7d32;">R${(o.total || 0).toFixed(2)}</span>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                showToast('Failed to load orders');
            }
        }
        
        // Customer: Profile
        function renderProfile() {
            document.getElementById('userInfo').innerHTML = `
                <h3 style="margin-bottom: 8px;">${currentUser.name}</h3>
                <p style="color: #666; font-size: 14px;">üìß ${currentUser.email}</p>
                <p style="color: #666; font-size: 14px;">üë§ ${currentUser.role}</p>
            `;
        }
        
        // Staff: Orders
        async function loadStaffOrders() {
            try {
                const res = await fetch(`${API_URL}/orders`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                let orders = await res.json();
                
                if (currentUser.role !== 'superuser' && currentUser.courseIds && currentUser.courseIds.length > 0) {
                    orders = orders.filter(o => currentUser.courseIds.includes(o.courseId));
                }
                
                allOrders = orders;
                updateStaffStats();
                renderStaffTabs();
                renderStaffOrders();
            } catch (e) {
                console.error('Error loading orders:', e);
            }
        }
        
        function updateStaffStats() {
            document.getElementById('statPending').textContent = allOrders.filter(o => o.status === 'pending').length;
            document.getElementById('statPreparing').textContent = allOrders.filter(o => o.status === 'preparing').length;
            document.getElementById('statReady').textContent = allOrders.filter(o => o.status === 'ready').length;
            document.getElementById('statCompleted').textContent = allOrders.filter(o => o.status === 'completed').length;
        }
        
        function renderStaffTabs() {
            const tabs = [
                { filter: 'pending', label: 'Pending' },
                { filter: 'preparing', label: 'Preparing' },
                { filter: 'ready', label: 'Ready' },
                { filter: 'completed', label: 'Completed' },
                { filter: 'all', label: 'All' }
            ];
            
            document.getElementById('staffOrderTabs').innerHTML = tabs.map(t => 
                `<button class="tab-btn ${staffFilter === t.filter ? 'active' : ''}" onclick="filterStaffOrders('${t.filter}')">${t.label}</button>`
            ).join('');
        }
        
        function filterStaffOrders(filter) {
            staffFilter = filter;
            renderStaffTabs();
            renderStaffOrders();
        }
        
        function getOrderNumber(id) {
            return (parseInt(id.slice(-8), 16) % 1000000).toString().padStart(6, '0');
        }
        
        function renderStaffOrders() {
            const orders = staffFilter === 'all' ? allOrders : allOrders.filter(o => o.status === staffFilter);
            orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            const list = document.getElementById('staffOrdersList');
            
            if (orders.length === 0) {
                list.innerHTML = '<div class="empty-state"><p>No orders</p></div>';
                return;
            }
            
            list.innerHTML = orders.slice(0, 50).map(o => {
                const time = new Date(o.createdAt).toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
                const allItems = o.items.map(i => `${i.quantity}x ${i.name}`).join(' ¬∑ ');
                
                return `
                    <div class="staff-order-card status-${o.status}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 6px; font-size: 13px; margin-bottom: 3px;">
                                    <strong>#${getOrderNumber(o.id)}</strong>
                                    <span style="color: #666;">${time}</span>
                                    ${o.teeOffTime ? `<span style="color: #1565c0; font-size: 11px;">‚õ≥${o.teeOffTime}</span>` : ''}
                                </div>
                                <div style="font-size: 12px; font-weight: 500;">üë§ ${o.customerName || 'Guest'}</div>
                                <div style="font-size: 12px; color: #333; margin-top: 3px; line-height: 1.4;">${allItems}</div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px; flex-shrink: 0;">
                                <strong style="color: #2e7d32; font-size: 14px;">R${(o.total || 0).toFixed(0)}</strong>
                                ${getStaffActions(o)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getStaffActions(order) {
            const role = currentUser.role;
            const isAdmin = ['admin', 'superuser'].includes(role);
            
            if (order.status === 'pending') {
                return `<button class="btn btn-sm btn-warning" style="padding: 6px 10px; font-size: 11px;" onclick="updateOrderStatus('${order.id}', 'preparing')">üë®‚Äçüç≥</button>`;
            }
            if (order.status === 'preparing') {
                return `<button class="btn btn-sm btn-success" style="padding: 6px 10px; font-size: 11px;" onclick="updateOrderStatus('${order.id}', 'ready')">‚úÖ</button>`;
            }
            if (order.status === 'ready') {
                return `<button class="btn btn-sm btn-info" style="padding: 6px 10px; font-size: 11px;" onclick="updateOrderStatus('${order.id}', 'completed')">üì¶</button>`;
            }
            return '';
        }
        
        async function updateOrderStatus(id, status) {
            try {
                const res = await fetch(`${API_URL}/orders/${id}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ status })
                });
                
                if (res.ok) {
                    showToast('Order updated');
                    loadStaffOrders();
                } else {
                    showToast('Failed to update');
                }
            } catch (e) {
                showToast('Connection error');
            }
        }
        
        // Navigation
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        
        function navigateTo(section) {
            document.querySelectorAll('#customerNav .nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`#customerNav [data-nav="${section}"]`)?.classList.add('active');
            
            switch(section) {
                case 'menu': showScreen('menuScreen'); break;
                case 'cart': renderCart(); showScreen('cartScreen'); break;
                case 'orders': loadCustomerOrders(); showScreen('ordersScreen'); break;
                case 'profile': renderProfile(); showScreen('profileScreen'); break;
            }
        }
        
        function staffNavigateTo(section) {
            document.querySelectorAll('#staffNav .nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`#staffNav [data-nav="${section}"]`)?.classList.add('active');
            
            if (section === 'dashboard') {
                showScreen('staffDashboard');
            } else if (section === 'profile') {
                renderProfile();
                showScreen('profileScreen');
            }
        }
        
        // Modals
        function showPasswordModal() {
            document.getElementById('passwordModal').classList.add('visible');
        }
        
        function hideModal(id) {
            document.getElementById(id).classList.remove('visible');
        }
        
        async function changePassword() {
            const current = document.getElementById('currentPassword').value;
            const newPwd = document.getElementById('newPasswordInput').value;
            
            if (!current || !newPwd) { showToast('Please fill all fields'); return; }
            
            try {
                const res = await fetch(`${API_URL}/profile/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ current_password: current, new_password: newPwd })
                });
                
                if (res.ok) {
                    showToast('Password changed');
                    hideModal('passwordModal');
                } else {
                    showToast('Failed to change password');
                }
            } catch (e) {
                showToast('Connection error');
            }
        }
        
        // Toast
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }
    </script>
</body>
</html>
