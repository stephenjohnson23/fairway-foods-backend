<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2e7d32">
    <title>Fairway Foods - Order Food on the Course</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
        }
        
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        /* Login Screen */
        .screen {
            display: none;
            padding: 20px;
        }
        
        .screen.active {
            display: block;
        }
        
        .login-container {
            padding-top: 40px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #2e7d32;
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            margin-top: 10px;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .link-btn {
            background: none;
            border: none;
            color: #2e7d32;
            font-size: 14px;
            cursor: pointer;
            margin-top: 20px;
            text-decoration: underline;
        }
        
        /* Course Selection */
        .course-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .course-card:hover, .course-card.selected {
            border-color: #2e7d32;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.15);
        }
        
        .course-card h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .course-card p {
            color: #666;
            font-size: 14px;
        }
        
        /* Menu Items */
        .menu-categories {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 15px 0;
            margin-bottom: 15px;
            -webkit-overflow-scrolling: touch;
        }
        
        .category-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: #f0f0f0;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .category-btn.active {
            background: #2e7d32;
            color: white;
        }
        
        .menu-item {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .menu-item-info h4 {
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .menu-item-info p {
            color: #666;
            font-size: 13px;
            margin-bottom: 6px;
        }
        
        .menu-item-price {
            color: #2e7d32;
            font-weight: 600;
            font-size: 16px;
        }
        
        .add-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #2e7d32;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Cart */
        .cart-badge {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: #2e7d32;
            color: white;
            padding: 16px 24px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(46, 125, 50, 0.4);
            z-index: 100;
            display: none;
        }
        
        .cart-badge.visible {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item-qty {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .qty-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #2e7d32;
            background: white;
            color: #2e7d32;
            font-size: 18px;
            cursor: pointer;
        }
        
        .cart-total {
            padding: 20px;
            background: #f9f9f9;
            border-radius: 16px;
            margin: 20px 0;
        }
        
        .cart-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .cart-total-row.total {
            font-size: 20px;
            font-weight: 700;
            color: #2e7d32;
            border-top: 2px solid #e0e0e0;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        /* Orders */
        .order-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .order-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-preparing { background: #cce5ff; color: #004085; }
        .status-ready { background: #d4edda; color: #155724; }
        .status-completed { background: #e2e3e5; color: #383d41; }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: #999;
            font-size: 12px;
            cursor: pointer;
            padding: 8px 16px;
        }
        
        .nav-item.active {
            color: #2e7d32;
        }
        
        .nav-item svg {
            width: 24px;
            height: 24px;
        }
        
        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top-color: #2e7d32;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 200;
        }
        
        .toast.visible {
            opacity: 1;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }
        
        .modal-overlay.visible {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 20px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal h2 {
            margin-bottom: 20px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        /* User Info */
        .user-info {
            background: #f9f9f9;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .user-info h3 {
            margin-bottom: 10px;
        }
        
        .user-info p {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        /* Pending Approval */
        .pending-approval {
            text-align: center;
            padding: 60px 20px;
        }
        
        .pending-approval svg {
            width: 100px;
            height: 100px;
            color: #ffc107;
            margin-bottom: 20px;
        }
        
        .pending-approval h2 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .pending-approval p {
            color: #666;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>‚õ≥ Fairway Foods</h1>
            <p class="header-subtitle" id="headerSubtitle">Order food on the course</p>
        </div>
        
        <!-- Login Screen -->
        <div class="screen active" id="loginScreen">
            <div class="login-container">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                </div>
                <button class="btn btn-primary" onclick="login()">Sign In</button>
                <button class="btn btn-secondary" onclick="showScreen('registerScreen')">Create Account</button>
                <button class="link-btn" onclick="showScreen('forgotPasswordScreen')">Forgot Password?</button>
            </div>
        </div>
        
        <!-- Register Screen -->
        <div class="screen" id="registerScreen">
            <div class="login-container">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="registerName" placeholder="John Smith">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="registerPassword" placeholder="Create a password">
                </div>
                <button class="btn btn-primary" onclick="register()">Create Account</button>
                <button class="btn btn-secondary" onclick="showScreen('loginScreen')">Back to Sign In</button>
            </div>
        </div>
        
        <!-- Forgot Password Screen -->
        <div class="screen" id="forgotPasswordScreen">
            <div class="login-container">
                <h2 style="margin-bottom: 10px;">Reset Password</h2>
                <p style="color: #666; margin-bottom: 20px;">Enter your email and we'll send you a reset code.</p>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="forgotEmail" placeholder="your@email.com">
                </div>
                <button class="btn btn-primary" onclick="sendResetCode()">Send Reset Code</button>
                <button class="btn btn-secondary" onclick="showScreen('loginScreen')">Back to Sign In</button>
            </div>
        </div>
        
        <!-- Reset Code Screen -->
        <div class="screen" id="resetCodeScreen">
            <div class="login-container">
                <h2 style="margin-bottom: 10px;">Enter Code</h2>
                <p style="color: #666; margin-bottom: 20px;">Check your email for the 6-digit code.</p>
                <div class="form-group">
                    <label>Reset Code</label>
                    <input type="text" id="resetCode" placeholder="123456" maxlength="6">
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="newPassword" placeholder="Enter new password">
                </div>
                <button class="btn btn-primary" onclick="resetPassword()">Reset Password</button>
                <button class="btn btn-secondary" onclick="showScreen('loginScreen')">Back to Sign In</button>
            </div>
        </div>
        
        <!-- Pending Approval Screen -->
        <div class="screen" id="pendingScreen">
            <div class="pending-approval">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12,6 12,12 16,14"></polyline>
                </svg>
                <h2>Account Pending Approval</h2>
                <p>Your account is being reviewed by the club administrator. You'll receive an email once approved.</p>
                <button class="btn btn-secondary" style="margin-top: 30px;" onclick="logout()">Sign Out</button>
            </div>
        </div>
        
        <!-- Course Selection Screen -->
        <div class="screen" id="courseScreen">
            <h2 style="margin-bottom: 20px;">Select Your Course</h2>
            <div id="courseList"></div>
        </div>
        
        <!-- Menu Screen -->
        <div class="screen" id="menuScreen">
            <div class="menu-categories" id="categoryTabs"></div>
            <div id="menuList"></div>
        </div>
        
        <!-- Cart Screen -->
        <div class="screen" id="cartScreen">
            <h2 style="margin-bottom: 20px;">Your Order</h2>
            <div id="cartItems"></div>
            <div class="cart-total" id="cartTotal" style="display: none;">
                <div class="cart-total-row">
                    <span>Subtotal</span>
                    <span id="subtotal">R0.00</span>
                </div>
                <div class="cart-total-row total">
                    <span>Total</span>
                    <span id="totalAmount">R0.00</span>
                </div>
            </div>
            <div class="form-group">
                <label>Your Name (for pickup)</label>
                <input type="text" id="customerName" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label>Tee-off Time (optional)</label>
                <input type="time" id="teeOffTime">
            </div>
            <button class="btn btn-primary" id="placeOrderBtn" onclick="placeOrder()">Place Order</button>
        </div>
        
        <!-- Orders Screen -->
        <div class="screen" id="ordersScreen">
            <h2 style="margin-bottom: 20px;">Your Orders</h2>
            <div id="ordersList"></div>
        </div>
        
        <!-- Profile Screen -->
        <div class="screen" id="profileScreen">
            <h2 style="margin-bottom: 20px;">Profile</h2>
            <div class="user-info" id="userInfo"></div>
            <button class="btn btn-secondary" onclick="showChangePasswordModal()">Change Password</button>
            <button class="btn btn-danger" style="margin-top: 10px;" onclick="logout()">Sign Out</button>
        </div>
        
        <!-- Cart Badge -->
        <div class="cart-badge" id="cartBadge" onclick="showScreen('cartScreen')">
            üõí <span id="cartCount">0</span> items - <span id="cartBadgeTotal">R0</span>
        </div>
        
        <!-- Bottom Navigation -->
        <div class="bottom-nav" id="bottomNav" style="display: none;">
            <button class="nav-item active" onclick="navigateTo('menu')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3h18v18H3zM3 9h18M9 21V9"></path>
                </svg>
                Menu
            </button>
            <button class="nav-item" onclick="navigateTo('cart')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
                Cart
            </button>
            <button class="nav-item" onclick="navigateTo('orders')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                Orders
            </button>
            <button class="nav-item" onclick="navigateTo('profile')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                Profile
            </button>
        </div>
        
        <!-- Toast -->
        <div class="toast" id="toast"></div>
        
        <!-- Change Password Modal -->
        <div class="modal-overlay" id="passwordModal">
            <div class="modal">
                <h2>Change Password</h2>
                <div class="form-group">
                    <label>Current Password</label>
                    <input type="password" id="currentPassword" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="newPasswordChange" placeholder="Enter new password">
                </div>
                <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
                <button class="btn btn-secondary" onclick="hideModal('passwordModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        // ============ CONFIGURATION ============
        const API_URL = 'https://fairway-foods-backend.onrender.com/api';
        
        // ============ STATE ============
        let currentUser = null;
        let currentCourse = null;
        let menuItems = [];
        let cart = [];
        let categories = [];
        let activeCategory = 'All';
        
        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });
        
        function checkAuth() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                currentUser = JSON.parse(user);
                
                if (currentUser.status === 'pending') {
                    showScreen('pendingScreen');
                } else if (currentUser.role === 'user') {
                    loadCourses();
                } else {
                    showToast('Please use the mobile app for staff access');
                    logout();
                }
            }
        }
        
        // ============ AUTH ============
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showToast('Please enter email and password');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('token', data.access_token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    currentUser = data.user;
                    
                    if (currentUser.status === 'pending') {
                        showScreen('pendingScreen');
                    } else if (currentUser.role === 'user') {
                        loadCourses();
                    } else {
                        showToast('Please use the mobile app for staff access');
                        logout();
                    }
                } else {
                    showToast(data.detail || 'Login failed');
                }
            } catch (error) {
                showToast('Connection error. Please try again.');
            }
        }
        
        async function register() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            if (!name || !email || !password) {
                showToast('Please fill all fields');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('Account created! Waiting for approval.');
                    showScreen('loginScreen');
                } else {
                    showToast(data.detail || 'Registration failed');
                }
            } catch (error) {
                showToast('Connection error. Please try again.');
            }
        }
        
        async function sendResetCode() {
            const email = document.getElementById('forgotEmail').value;
            
            if (!email) {
                showToast('Please enter your email');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/auth/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                if (response.ok) {
                    showToast('Reset code sent to your email');
                    showScreen('resetCodeScreen');
                } else {
                    const data = await response.json();
                    showToast(data.detail || 'Failed to send reset code');
                }
            } catch (error) {
                showToast('Connection error. Please try again.');
            }
        }
        
        async function resetPassword() {
            const email = document.getElementById('forgotEmail').value;
            const code = document.getElementById('resetCode').value;
            const newPassword = document.getElementById('newPassword').value;
            
            if (!code || !newPassword) {
                showToast('Please enter code and new password');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code, new_password: newPassword })
                });
                
                if (response.ok) {
                    showToast('Password reset successful!');
                    showScreen('loginScreen');
                } else {
                    const data = await response.json();
                    showToast(data.detail || 'Reset failed');
                }
            } catch (error) {
                showToast('Connection error. Please try again.');
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            currentUser = null;
            currentCourse = null;
            cart = [];
            document.getElementById('bottomNav').style.display = 'none';
            showScreen('loginScreen');
        }
        
        // ============ COURSES ============
        async function loadCourses() {
            try {
                const response = await fetch(`${API_URL}/golf-courses`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                const courses = await response.json();
                
                const courseList = document.getElementById('courseList');
                courseList.innerHTML = courses.map(course => `
                    <div class="course-card" onclick="selectCourse('${course.id}', '${course.name}')">
                        <h3>${course.name}</h3>
                        <p>üìç ${course.location}</p>
                    </div>
                `).join('');
                
                showScreen('courseScreen');
            } catch (error) {
                showToast('Failed to load courses');
            }
        }
        
        function selectCourse(courseId, courseName) {
            currentCourse = { id: courseId, name: courseName };
            document.getElementById('headerSubtitle').textContent = courseName;
            loadMenu();
        }
        
        // ============ MENU ============
        async function loadMenu() {
            try {
                const response = await fetch(`${API_URL}/menu-items?courseId=${currentCourse.id}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                menuItems = await response.json();
                
                // Get unique categories
                categories = ['All', ...new Set(menuItems.map(item => item.category))];
                
                renderCategories();
                renderMenu();
                
                document.getElementById('bottomNav').style.display = 'flex';
                showScreen('menuScreen');
            } catch (error) {
                showToast('Failed to load menu');
            }
        }
        
        function renderCategories() {
            const categoryTabs = document.getElementById('categoryTabs');
            categoryTabs.innerHTML = categories.map(cat => `
                <button class="category-btn ${cat === activeCategory ? 'active' : ''}" 
                        onclick="filterCategory('${cat}')">${cat}</button>
            `).join('');
        }
        
        function filterCategory(category) {
            activeCategory = category;
            renderCategories();
            renderMenu();
        }
        
        function renderMenu() {
            const filteredItems = activeCategory === 'All' 
                ? menuItems.filter(item => item.available)
                : menuItems.filter(item => item.category === activeCategory && item.available);
            
            const menuList = document.getElementById('menuList');
            
            if (filteredItems.length === 0) {
                menuList.innerHTML = `
                    <div class="empty-state">
                        <p>No items available in this category</p>
                    </div>
                `;
                return;
            }
            
            menuList.innerHTML = filteredItems.map(item => `
                <div class="menu-item">
                    <div class="menu-item-info">
                        <h4>${item.name}</h4>
                        <p>${item.description || ''}</p>
                        <span class="menu-item-price">R${item.price.toFixed(2)}</span>
                    </div>
                    <button class="add-btn" onclick="addToCart('${item.id}')">+</button>
                </div>
            `).join('');
        }
        
        // ============ CART ============
        function addToCart(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            
            const existingItem = cart.find(c => c.id === itemId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ ...item, quantity: 1 });
            }
            
            updateCartBadge();
            showToast(`${item.name} added to cart`);
        }
        
        function updateCartBadge() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            document.getElementById('cartCount').textContent = totalItems;
            document.getElementById('cartBadgeTotal').textContent = `R${totalPrice.toFixed(0)}`;
            
            const cartBadge = document.getElementById('cartBadge');
            if (totalItems > 0) {
                cartBadge.classList.add('visible');
            } else {
                cartBadge.classList.remove('visible');
            }
        }
        
        function renderCart() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="empty-state">
                        <p>Your cart is empty</p>
                        <button class="btn btn-primary" style="margin-top: 20px; width: auto; padding: 12px 24px;" 
                                onclick="navigateTo('menu')">Browse Menu</button>
                    </div>
                `;
                cartTotal.style.display = 'none';
                document.getElementById('placeOrderBtn').style.display = 'none';
                return;
            }
            
            cartItems.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div>
                        <h4>${item.name}</h4>
                        <p style="color: #666;">R${item.price.toFixed(2)} each</p>
                    </div>
                    <div class="cart-item-qty">
                        <button class="qty-btn" onclick="updateQuantity('${item.id}', -1)">-</button>
                        <span>${item.quantity}</span>
                        <button class="qty-btn" onclick="updateQuantity('${item.id}', 1)">+</button>
                    </div>
                </div>
            `).join('');
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('subtotal').textContent = `R${total.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `R${total.toFixed(2)}`;
            
            cartTotal.style.display = 'block';
            document.getElementById('placeOrderBtn').style.display = 'block';
        }
        
        function updateQuantity(itemId, change) {
            const item = cart.find(c => c.id === itemId);
            if (!item) return;
            
            item.quantity += change;
            
            if (item.quantity <= 0) {
                cart = cart.filter(c => c.id !== itemId);
            }
            
            updateCartBadge();
            renderCart();
        }
        
        // ============ ORDERS ============
        async function placeOrder() {
            if (cart.length === 0) {
                showToast('Your cart is empty');
                return;
            }
            
            const customerName = document.getElementById('customerName').value || currentUser.name;
            const teeOffTime = document.getElementById('teeOffTime').value;
            
            const orderData = {
                items: cart.map(item => ({
                    menuItemId: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                })),
                total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                customerName,
                teeOffTime: teeOffTime || null,
                courseId: currentCourse.id
            };
            
            try {
                const response = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    cart = [];
                    updateCartBadge();
                    showToast('Order placed successfully!');
                    navigateTo('orders');
                } else {
                    showToast('Failed to place order');
                }
            } catch (error) {
                showToast('Connection error. Please try again.');
            }
        }
        
        async function loadOrders() {
            try {
                const response = await fetch(`${API_URL}/orders/my-orders`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                const orders = await response.json();
                
                const ordersList = document.getElementById('ordersList');
                
                if (orders.length === 0) {
                    ordersList.innerHTML = `
                        <div class="empty-state">
                            <p>No orders yet</p>
                            <button class="btn btn-primary" style="margin-top: 20px; width: auto; padding: 12px 24px;" 
                                    onclick="navigateTo('menu')">Order Now</button>
                        </div>
                    `;
                    return;
                }
                
                ordersList.innerHTML = orders.map(order => `
                    <div class="order-card">
                        <div class="order-header">
                            <span style="color: #666; font-size: 14px;">${new Date(order.createdAt).toLocaleDateString()}</span>
                            <span class="order-status status-${order.status}">${order.status.toUpperCase()}</span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            ${order.items.map(item => `
                                <p style="font-size: 14px;">${item.quantity}x ${item.name}</p>
                            `).join('')}
                        </div>
                        <div style="display: flex; justify-content: space-between; font-weight: 600;">
                            <span>Total</span>
                            <span style="color: #2e7d32;">R${order.total.toFixed(2)}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showToast('Failed to load orders');
            }
        }
        
        // ============ PROFILE ============
        function renderProfile() {
            const userInfo = document.getElementById('userInfo');
            userInfo.innerHTML = `
                <h3>${currentUser.name}</h3>
                <p>üìß ${currentUser.email}</p>
                <p>üë§ ${currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1)}</p>
            `;
        }
        
        function showChangePasswordModal() {
            document.getElementById('passwordModal').classList.add('visible');
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('visible');
        }
        
        async function changePassword() {
            const currentPwd = document.getElementById('currentPassword').value;
            const newPwd = document.getElementById('newPasswordChange').value;
            
            if (!currentPwd || !newPwd) {
                showToast('Please fill all fields');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/profile/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        current_password: currentPwd,
                        new_password: newPwd
                    })
                });
                
                if (response.ok) {
                    showToast('Password changed successfully');
                    hideModal('passwordModal');
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPasswordChange').value = '';
                } else {
                    const data = await response.json();
                    showToast(data.detail || 'Failed to change password');
                }
            } catch (error) {
                showToast('Connection error. Please try again.');
            }
        }
        
        // ============ NAVIGATION ============
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        function navigateTo(section) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.target.closest('.nav-item')?.classList.add('active');
            
            switch(section) {
                case 'menu':
                    showScreen('menuScreen');
                    break;
                case 'cart':
                    renderCart();
                    showScreen('cartScreen');
                    break;
                case 'orders':
                    loadOrders();
                    showScreen('ordersScreen');
                    break;
                case 'profile':
                    renderProfile();
                    showScreen('profileScreen');
                    break;
            }
        }
        
        // ============ UTILITIES ============
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }
    </script>
</body>
</html>
