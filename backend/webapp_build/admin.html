<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1b5e20">
    <title>Fairway Foods - Staff Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #1b5e20 0%, #0d3d0f 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 700;
        }
        
        .header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }
        
        /* Layout */
        .layout {
            display: flex;
            min-height: calc(100vh - 60px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 220px;
            background: white;
            border-right: 1px solid #e0e0e0;
            padding: 20px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            color: #666;
            transition: all 0.2s;
        }
        
        .nav-item:hover {
            background: #f5f5f5;
            color: #333;
        }
        
        .nav-item.active {
            background: #e8f5e9;
            color: #1b5e20;
            border-right: 3px solid #1b5e20;
            font-weight: 600;
        }
        
        .nav-item .icon {
            font-size: 18px;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .section { display: none; }
        .section.active { display: block; }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .stat-card h3 {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #1b5e20;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f9f9f9;
            font-weight: 600;
            font-size: 13px;
            color: #666;
        }
        
        tr:hover {
            background: #f9f9f9;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .btn:hover { opacity: 0.9; }
        
        .btn-primary { background: #1b5e20; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        /* Status badges */
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-approved, .badge-active { background: #d4edda; color: #155724; }
        .badge-rejected { background: #f8d7da; color: #721c24; }
        .badge-preparing { background: #cce5ff; color: #004085; }
        .badge-ready { background: #d4edda; color: #155724; }
        .badge-completed { background: #e2e3e5; color: #383d41; }
        
        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
            color: #555;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #1b5e20;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        
        .modal-overlay.visible { display: flex; }
        
        .modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            font-size: 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .modal-actions .btn {
            flex: 1;
        }
        
        /* Order cards */
        .order-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .order-items {
            border-top: 1px solid #eee;
            padding-top: 12px;
            margin-bottom: 12px;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
        }
        
        .order-total {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            font-size: 16px;
            color: #1b5e20;
            border-top: 2px solid #eee;
            padding-top: 12px;
        }
        
        .order-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 300;
        }
        
        .toast.visible { opacity: 1; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        
        .tab-btn.active {
            border-color: #1b5e20;
            background: #1b5e20;
            color: white;
        }
        
        /* Login */
        .login-container {
            max-width: 400px;
            margin: 80px auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .login-container h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #1b5e20;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .layout { flex-direction: column; }
            .form-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        .mobile-nav {
            display: none;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 10px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        @media (max-width: 768px) {
            .mobile-nav {
                display: flex;
                justify-content: space-around;
            }
            .main-content {
                padding-bottom: 80px;
            }
        }
        
        .mobile-nav button {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .mobile-nav button.active {
            color: #1b5e20;
        }
        
        .mobile-nav .icon {
            font-size: 20px;
        }
        
        /* Checkbox */
        .checkbox-group {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
        }
        
        .checkbox-item input {
            width: auto;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <h2>‚õ≥ Staff Portal</h2>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="staff@golf.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="login()">Sign In</button>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <div class="header">
            <h1>‚õ≥ Fairway Foods Staff</h1>
            <div class="header-info">
                <span class="user-badge" id="userRole">Admin</span>
                <button class="logout-btn" onclick="logout()">Sign Out</button>
            </div>
        </div>
        
        <div class="layout">
            <!-- Sidebar -->
            <div class="sidebar">
                <button class="nav-item active" onclick="showSection('dashboard')" data-section="dashboard">
                    <span class="icon">üìä</span> Dashboard
                </button>
                <button class="nav-item" onclick="showSection('orders')" data-section="orders">
                    <span class="icon">üìã</span> Orders
                </button>
                <button class="nav-item" onclick="showSection('menu')" data-section="menu" id="navMenu">
                    <span class="icon">üçΩÔ∏è</span> Menu
                </button>
                <button class="nav-item" onclick="showSection('users')" data-section="users" id="navUsers">
                    <span class="icon">üë•</span> Users
                </button>
                <button class="nav-item" onclick="showSection('courses')" data-section="courses" id="navCourses">
                    <span class="icon">‚õ≥</span> Courses
                </button>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <!-- Dashboard -->
                <div class="section active" id="sectionDashboard">
                    <h2 style="margin-bottom: 20px;">Dashboard</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>üïê Pending Orders</h3>
                            <div class="value" id="statPending">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>üë®‚Äçüç≥ Preparing</h3>
                            <div class="value" id="statPreparing">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>‚úÖ Ready</h3>
                            <div class="value" id="statReady">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>üì¶ Completed</h3>
                            <div class="value" id="statCompleted">0</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Recent Orders</span>
                            <button class="btn btn-sm btn-secondary" onclick="loadOrders()">üîÑ Refresh</button>
                        </div>
                        <div id="recentOrders"></div>
                    </div>
                </div>
                
                <!-- Orders Section -->
                <div class="section" id="sectionOrders">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">All Orders</span>
                            <button class="btn btn-sm btn-secondary" onclick="loadOrders()">üîÑ Refresh</button>
                        </div>
                        <div class="tabs">
                            <button class="tab-btn active" onclick="filterOrders('all')">All</button>
                            <button class="tab-btn" onclick="filterOrders('pending')">Pending</button>
                            <button class="tab-btn" onclick="filterOrders('preparing')">Preparing</button>
                            <button class="tab-btn" onclick="filterOrders('ready')">Ready</button>
                            <button class="tab-btn" onclick="filterOrders('completed')">Completed</button>
                        </div>
                        <div id="ordersContainer"></div>
                    </div>
                </div>
                
                <!-- Menu Section -->
                <div class="section" id="sectionMenu">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Menu Items</span>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="menuCourseFilter" onchange="loadMenu()" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;"></select>
                                <button class="btn btn-sm btn-primary" onclick="openMenuModal()">+ Add Item</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="menuTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Users Section -->
                <div class="section" id="sectionUsers">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">User Management</span>
                            <button class="btn btn-sm btn-primary" onclick="openUserModal()">+ Add User</button>
                        </div>
                        <div class="tabs">
                            <button class="tab-btn active" onclick="filterUsers('all')">All</button>
                            <button class="tab-btn" onclick="filterUsers('pending')">Pending Approval</button>
                            <button class="tab-btn" onclick="filterUsers('approved')">Approved</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Courses Section -->
                <div class="section" id="sectionCourses">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Golf Courses</span>
                            <button class="btn btn-sm btn-primary" onclick="openCourseModal()">+ Add Course</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="coursesTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mobile Navigation -->
        <div class="mobile-nav">
            <button onclick="showSection('dashboard')" data-section="dashboard" class="active">
                <span class="icon">üìä</span>
                <span>Home</span>
            </button>
            <button onclick="showSection('orders')" data-section="orders">
                <span class="icon">üìã</span>
                <span>Orders</span>
            </button>
            <button onclick="showSection('menu')" data-section="menu">
                <span class="icon">üçΩÔ∏è</span>
                <span>Menu</span>
            </button>
            <button onclick="showSection('users')" data-section="users">
                <span class="icon">üë•</span>
                <span>Users</span>
            </button>
        </div>
    </div>
    
    <!-- User Modal -->
    <div class="modal-overlay" id="userModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="userModalTitle">Add User</h2>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="userName" placeholder="Full name">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="userEmail" placeholder="email@example.com">
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="userRole2">
                    <option value="user">User (Customer)</option>
                    <option value="kitchen">Kitchen Staff</option>
                    <option value="cashier">Cashier</option>
                    <option value="admin">Admin</option>
                    <option value="superuser">Super User</option>
                </select>
            </div>
            <div class="form-group">
                <label>Password (leave blank to keep current)</label>
                <input type="password" id="userPassword" placeholder="New password">
            </div>
            <div class="form-group">
                <label>Assigned Courses</label>
                <div class="checkbox-group" id="userCourses"></div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveUser()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Menu Modal -->
    <div class="modal-overlay" id="menuModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="menuModalTitle">Add Menu Item</h2>
                <button class="modal-close" onclick="closeModal('menuModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="menuName" placeholder="Item name">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="menuDescription" rows="2" placeholder="Description"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Price (R)</label>
                    <input type="number" id="menuPrice" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="menuCategory">
                        <option value="Starters">Starters</option>
                        <option value="Mains">Mains</option>
                        <option value="Desserts">Desserts</option>
                        <option value="Beverages">Beverages</option>
                        <option value="Snacks">Snacks</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="menuAvailable" checked> Available
                </label>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('menuModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveMenuItem()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Course Modal -->
    <div class="modal-overlay" id="courseModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="courseModalTitle">Add Course</h2>
                <button class="modal-close" onclick="closeModal('courseModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Course Name</label>
                <input type="text" id="courseName" placeholder="Golf course name">
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" id="courseLocation" placeholder="City, Region">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="courseDescription" rows="2" placeholder="Description"></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="courseActive" checked> Active
                </label>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('courseModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveCourse()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <script>
        const API_URL = 'https://fairway-foods-backend.onrender.com/api';
        
        let currentUser = null;
        let allOrders = [];
        let allUsers = [];
        let allCourses = [];
        let allMenu = [];
        let editingId = null;
        let currentFilter = 'all';
        let userFilter = 'all';
        
        // Init
        document.addEventListener('DOMContentLoaded', checkAuth);
        
        function checkAuth() {
            const token = localStorage.getItem('staffToken');
            const user = localStorage.getItem('staffUser');
            if (token && user) {
                currentUser = JSON.parse(user);
                showApp();
            }
        }
        
        // Auth
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showToast('Please enter email and password');
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    if (data.user.role === 'user') {
                        showToast('Access denied. Staff accounts only.');
                        return;
                    }
                    localStorage.setItem('staffToken', data.token);
                    localStorage.setItem('staffUser', JSON.stringify(data.user));
                    currentUser = data.user;
                    showApp();
                } else {
                    showToast(data.detail || 'Login failed');
                }
            } catch (e) {
                showToast('Connection error');
            }
        }
        
        function logout() {
            localStorage.removeItem('staffToken');
            localStorage.removeItem('staffUser');
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        }
        
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userRole').textContent = currentUser.role;
            
            // Hide admin-only sections for non-admin users
            const isAdmin = ['admin', 'superuser'].includes(currentUser.role);
            document.getElementById('navUsers').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('navCourses').style.display = currentUser.role === 'superuser' ? 'flex' : 'none';
            document.getElementById('navMenu').style.display = isAdmin ? 'flex' : 'none';
            
            // For cashier/kitchen, default to pending orders and go to orders section
            if (currentUser.role === 'cashier' || currentUser.role === 'kitchen') {
                currentFilter = 'pending';
                showSection('orders');
            }
            
            loadAllData();
            setInterval(loadOrders, 30000); // Auto refresh orders
        }
        
        async function loadAllData() {
            await Promise.all([loadOrders(), loadUsers(), loadCourses()]);
            loadMenu();
        }
        
        // Orders
        async function loadOrders() {
            try {
                const res = await fetch(`${API_URL}/orders`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('staffToken')}` }
                });
                if (res.ok) {
                    let orders = await res.json();
                    
                    // Filter orders for non-superuser (admin/kitchen/cashier only sees orders from assigned courses)
                    if (currentUser.role !== 'superuser' && currentUser.courseIds && currentUser.courseIds.length > 0) {
                        orders = orders.filter(o => currentUser.courseIds.includes(o.courseId));
                    }
                    
                    allOrders = orders;
                    updateStats();
                    renderOrders();
                }
            } catch (e) {
                console.error('Error loading orders:', e);
            }
        }
        
        function updateStats() {
            document.getElementById('statPending').textContent = allOrders.filter(o => o.status === 'pending').length;
            document.getElementById('statPreparing').textContent = allOrders.filter(o => o.status === 'preparing').length;
            document.getElementById('statReady').textContent = allOrders.filter(o => o.status === 'ready').length;
            document.getElementById('statCompleted').textContent = allOrders.filter(o => o.status === 'completed').length;
        }
        
        function filterOrders(filter) {
            currentFilter = filter;
            document.querySelectorAll('#sectionOrders .tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(filter) || (filter === 'all' && btn.textContent === 'All'));
            });
            renderOrders();
        }
        
        function renderOrders() {
            let orders = currentFilter === 'all' ? allOrders : allOrders.filter(o => o.status === currentFilter);
            orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Compact view for cashier/kitchen
            const isCompact = ['cashier', 'kitchen'].includes(currentUser.role);
            
            const html = orders.slice(0, 50).map(order => {
                const timeStr = new Date(order.createdAt).toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit' });
                const itemsSummary = order.items.map(i => `${i.quantity}x ${i.name}`).join(', ');
                
                if (isCompact) {
                    // Compact card for cashier/kitchen
                    return `
                        <div class="order-card" style="padding: 12px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <strong>#${order.id.slice(-6).toUpperCase()}</strong>
                                        <span class="badge badge-${order.status}" style="font-size: 10px; padding: 2px 8px;">${order.status}</span>
                                        <span style="color: #666; font-size: 12px;">${timeStr}</span>
                                    </div>
                                    <div style="font-size: 13px;">üë§ ${order.customerName || 'Guest'} ${order.teeOffTime ? `<span style="color: #1565c0;">‚õ≥ ${order.teeOffTime}</span>` : ''}</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 2px;">${itemsSummary}</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <strong style="color: #1b5e20;">R${(order.totalAmount || order.total || 0).toFixed(2)}</strong>
                                    ${getOrderActions(order)}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Full card for admin/superuser
                    return `
                        <div class="order-card">
                            <div class="order-header">
                                <div>
                                    <strong>#${order.id.slice(-6).toUpperCase()}</strong>
                                    <div style="color: #666; font-size: 13px;">${new Date(order.createdAt).toLocaleString()}</div>
                                    <div>üë§ ${order.customerName || 'Guest'}</div>
                                    ${order.teeOffTime ? `<div style="color: #1565c0; font-size: 12px;">‚õ≥ Tee-off: ${order.teeOffTime}</div>` : ''}
                                </div>
                                <span class="badge badge-${order.status}">${order.status}</span>
                            </div>
                            <div class="order-items">
                                ${order.items.map(i => `<div class="order-item"><span>${i.quantity}x ${i.name}</span><span>R${(i.price * i.quantity).toFixed(2)}</span></div>`).join('')}
                            </div>
                            <div class="order-total">
                                <span>Total</span>
                                <span>R${(order.totalAmount || order.total || 0).toFixed(2)}</span>
                            </div>
                            <div class="order-actions">
                                ${getOrderActions(order)}
                            </div>
                        </div>
                    `;
                }
            }).join('') || '<p style="color: #666; padding: 20px;">No orders found</p>';
            
            document.getElementById('ordersContainer').innerHTML = html;
            document.getElementById('recentOrders').innerHTML = html;
        }
        
        function getOrderActions(order) {
            const role = currentUser.role;
            const isAdmin = ['admin', 'superuser'].includes(role);
            
            // Cashier can move pending ‚Üí preparing, and ready ‚Üí completed
            if (order.status === 'pending' && (role === 'kitchen' || role === 'cashier' || isAdmin)) {
                return `<button class="btn btn-sm btn-warning" onclick="updateOrderStatus('${order.id}', 'preparing')">üë®‚Äçüç≥ Preparing</button>`;
            }
            if (order.status === 'preparing' && (role === 'kitchen' || role === 'cashier' || isAdmin)) {
                return `<button class="btn btn-sm btn-success" onclick="updateOrderStatus('${order.id}', 'ready')">‚úÖ Ready</button>`;
            }
            if (order.status === 'ready' && (role === 'cashier' || isAdmin)) {
                return `<button class="btn btn-sm btn-info" onclick="updateOrderStatus('${order.id}', 'completed')">üì¶ Complete</button>`;
            }
            return '';
        }
        
        async function updateOrderStatus(orderId, status) {
            try {
                const res = await fetch(`${API_URL}/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('staffToken')}`
                    },
                    body: JSON.stringify({ status })
                });
                if (res.ok) {
                    showToast('Order updated');
                    loadOrders();
                } else {
                    showToast('Failed to update order');
                }
            } catch (e) {
                showToast('Connection error');
            }
        }
        
        // Users
        async function loadUsers() {
            if (!['admin', 'superuser'].includes(currentUser?.role)) return;
            try {
                const res = await fetch(`${API_URL}/users`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('staffToken')}` }
                });
                if (res.ok) {
                    allUsers = await res.json();
                    renderUsers();
                }
            } catch (e) {
                console.error('Error loading users:', e);
            }
        }
        
        function filterUsers(filter) {
            userFilter = filter;
            document.querySelectorAll('#sectionUsers .tab-btn').forEach(btn => {
                const btnFilter = btn.textContent.toLowerCase().includes('pending') ? 'pending' : 
                                  btn.textContent.toLowerCase().includes('approved') ? 'approved' : 'all';
                btn.classList.toggle('active', btnFilter === filter);
            });
            renderUsers();
        }
        
        function renderUsers() {
            let users = allUsers;
            if (userFilter === 'pending') users = allUsers.filter(u => u.status === 'pending');
            if (userFilter === 'approved') users = allUsers.filter(u => u.status === 'approved');
            
            document.getElementById('usersTable').innerHTML = users.map(u => `
                <tr>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${u.role}</td>
                    <td><span class="badge badge-${u.status || 'approved'}">${u.status || 'approved'}</span></td>
                    <td>
                        ${u.status === 'pending' ? `
                            <button class="btn btn-sm btn-success" onclick="approveUser('${u.id}')">‚úì Approve</button>
                            <button class="btn btn-sm btn-danger" onclick="rejectUser('${u.id}')">‚úó Reject</button>
                        ` : `
                            <button class="btn btn-sm btn-secondary" onclick="editUser('${u.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}')">Delete</button>
                        `}
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="5" style="text-align: center; color: #666;">No users found</td></tr>';
        }
        
        function openUserModal(user = null) {
            editingId = user?.id || null;
            document.getElementById('userModalTitle').textContent = user ? 'Edit User' : 'Add User';
            document.getElementById('userName').value = user?.name || '';
            document.getElementById('userEmail').value = user?.email || '';
            document.getElementById('userRole2').value = user?.role || 'user';
            document.getElementById('userPassword').value = '';
            
            // Render course checkboxes
            document.getElementById('userCourses').innerHTML = allCourses.map(c => `
                <div class="checkbox-item">
                    <input type="checkbox" id="course_${c.id}" value="${c.id}" ${user?.courseIds?.includes(c.id) ? 'checked' : ''}>
                    <label for="course_${c.id}">${c.name}</label>
                </div>
            `).join('');
            
            document.getElementById('userModal').classList.add('visible');
        }
        
        function editUser(id) {
            const user = allUsers.find(u => u.id === id);
            if (user) openUserModal(user);
        }
        
        async function saveUser() {
            const data = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole2').value,
                courseIds: Array.from(document.querySelectorAll('#userCourses input:checked')).map(cb => cb.value)
            };
            
            const password = document.getElementById('userPassword').value;
            if (password) data.password = password;
            
            try {
                const url = editingId ? `${API_URL}/users/${editingId}` : `${API_URL}/users`;
                const res = await fetch(url, {
                    method: editingId ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('staffToken')}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    showToast('User saved');
                    closeModal('userModal');
                    loadUsers();
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'Failed to save user');
                }
            } catch (e) {
                showToast('Connection error');
            }
        }
        
        async function approveUser(id) {
            if (!confirm('Approve this user?')) return;
            try {
                const res = await fetch(`${API_URL}/users/${id}/approve`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('staffToken')}` }
                });
                if (res.ok) {
                    showToast('User approved');
                    loadUsers();
                }
            } catch (e) {
                showToast('Error approving user');
            }
        }
        
        async function rejectUser(id) {
            if (!confirm('Reject this user?')) return;
            try {
                const res = await fetch(`${API_URL}/users/${id}/reject`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('staffToken')}` }
                });
                if (res.ok) {
                    showToast('User rejected');
                    loadUsers();
                }
            } catch (e) {
                showToast('Error rejecting user');
            }
        }
        
        async function deleteUser(id) {
            if (!confirm('Delete this user? This cannot be undone.')) return;
            try {
                const res = await fetch(`${API_URL}/users/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('staffToken')}` }
                });
                if (res.ok) {
                    showToast('User deleted');
                    loadUsers();
                }
            } catch (e) {
                showToast('Error deleting user');
            }
        }
        
        // Courses
        async function loadCourses() {
            try {
                const res = await fetch(`${API_URL}/courses`);
                if (res.ok) {
                    let courses = await res.json();
                    
                    // Filter courses for non-superuser (admin only sees assigned courses)
                    if (currentUser.role !== 'superuser' && currentUser.courseIds && currentUser.courseIds.length > 0) {
                        courses = courses.filter(c => currentUser.courseIds.includes(c.id));
                    }
                    
                    allCourses = courses;
                    renderCourses();
                    
                    // Update menu filter dropdown
                    document.getElementById('menuCourseFilter').innerHTML = allCourses.map(c => 
                        `<option value="${c.id}">${c.name}</option>`
                    ).join('');
                }
            } catch (e) {
                console.error('Error loading courses:', e);
            }
        }
        
        function renderCourses() {
            document.getElementById('coursesTable').innerHTML = allCourses.map(c => `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.location}</td>
                    <td><span class="badge badge-${c.active !== false ? 'active' : 'rejected'}">${c.active !== false ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editCourse('${c.id}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCourse('${c.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function openCourseModal(course = null) {
            editingId = course?.id || null;
            document.getElementById('courseModalTitle').textContent = course ? 'Edit Course' : 'Add Course';
            document.getElementById('courseName').value = course?.name || '';
            document.getElementById('courseLocation').value = course?.location || '';
            document.getElementById('courseDescription').value = course?.description || '';
            document.getElementById('courseActive').checked = course?.active !== false;
            document.getElementById('courseModal').classList.add('visible');
        }
        
        function editCourse(id) {
            const course = allCourses.find(c => c.id === id);
            if (course) openCourseModal(course);
        }
        
        async function saveCourse() {
            const data = {
                name: document.getElementById('courseName').value,
                location: document.getElementById('courseLocation').value,
                description: document.getElementById('courseDescription').value,
                active: document.getElementById('courseActive').checked
            };
            
            try {
                const url = editingId ? `${API_URL}/courses/${editingId}` : `${API_URL}/courses`;
                const res = await fetch(url, {
                    method: editingId ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('staffToken')}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    showToast('Course saved');
                    closeModal('courseModal');
                    loadCourses();
                } else {
                    showToast('Failed to save course');
                }
            } catch (e) {
                showToast('Connection error');
            }
        }
        
        async function deleteCourse(id) {
            if (!confirm('Delete this course?')) return;
            try {
                const res = await fetch(`${API_URL}/courses/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('staffToken')}` }
                });
                if (res.ok) {
                    showToast('Course deleted');
                    loadCourses();
                }
            } catch (e) {
                showToast('Error deleting course');
            }
        }
        
        // Menu
        async function loadMenu() {
            const courseId = document.getElementById('menuCourseFilter').value;
            if (!courseId) return;
            
            try {
                const res = await fetch(`${API_URL}/menu?courseId=${courseId}`);
                if (res.ok) {
                    allMenu = await res.json();
                    renderMenu();
                }
            } catch (e) {
                console.error('Error loading menu:', e);
            }
        }
        
        function renderMenu() {
            document.getElementById('menuTable').innerHTML = allMenu.map(item => `
                <tr>
                    <td><strong>${item.name}</strong><br><small style="color: #666;">${item.description || ''}</small></td>
                    <td>${item.category}</td>
                    <td>R${item.price.toFixed(2)}</td>
                    <td><span class="badge badge-${item.available ? 'active' : 'rejected'}">${item.available ? 'Available' : 'Unavailable'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editMenuItem('${item.id}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMenuItem('${item.id}')">Delete</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="5" style="text-align: center; color: #666;">No menu items</td></tr>';
        }
        
        function openMenuModal(item = null) {
            editingId = item?.id || null;
            document.getElementById('menuModalTitle').textContent = item ? 'Edit Menu Item' : 'Add Menu Item';
            document.getElementById('menuName').value = item?.name || '';
            document.getElementById('menuDescription').value = item?.description || '';
            document.getElementById('menuPrice').value = item?.price || '';
            document.getElementById('menuCategory').value = item?.category || 'Mains';
            document.getElementById('menuAvailable').checked = item?.available !== false;
            document.getElementById('menuModal').classList.add('visible');
        }
        
        function editMenuItem(id) {
            const item = allMenu.find(m => m.id === id);
            if (item) openMenuModal(item);
        }
        
        async function saveMenuItem() {
            const courseId = document.getElementById('menuCourseFilter').value;
            const data = {
                name: document.getElementById('menuName').value,
                description: document.getElementById('menuDescription').value,
                price: parseFloat(document.getElementById('menuPrice').value),
                category: document.getElementById('menuCategory').value,
                available: document.getElementById('menuAvailable').checked,
                courseId: courseId
            };
            
            try {
                const url = editingId ? `${API_URL}/menu/${editingId}` : `${API_URL}/menu`;
                const res = await fetch(url, {
                    method: editingId ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('staffToken')}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    showToast('Menu item saved');
                    closeModal('menuModal');
                    loadMenu();
                } else {
                    showToast('Failed to save menu item');
                }
            } catch (e) {
                showToast('Connection error');
            }
        }
        
        async function deleteMenuItem(id) {
            if (!confirm('Delete this menu item?')) return;
            try {
                const res = await fetch(`${API_URL}/menu/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('staffToken')}` }
                });
                if (res.ok) {
                    showToast('Menu item deleted');
                    loadMenu();
                }
            } catch (e) {
                showToast('Error deleting menu item');
            }
        }
        
        // Navigation
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('section' + section.charAt(0).toUpperCase() + section.slice(1)).classList.add('active');
            
            document.querySelectorAll('.nav-item, .mobile-nav button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.section === section);
            });
        }
        
        // Modals
        function closeModal(id) {
            document.getElementById(id).classList.remove('visible');
            editingId = null;
        }
        
        // Toast
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }
    </script>
</body>
</html>
